package tools;

import java.util.Date;
import java.util.GregorianCalendar;

import org.bson.types.ObjectId;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.mongodb.BasicDBObject;
import com.mongodb.DBCollection;
import com.mongodb.DBCursor;
import com.mongodb.DBObject;

public class MessageTools {
	public static void addMessage(String id, String text, DBCollection coll){
		BasicDBObject obj = new BasicDBObject();
		GregorianCalendar calendar = new java.util.GregorianCalendar();
		Date d = calendar.getTime();
		obj.put("id", id);
		obj.put("text", text);
		obj.put("date", d);
		obj.put("comments", "");
		coll.insert(obj);
	}
	
	public static JSONObject getMessages(String id_user, DBCollection coll) throws JSONException{
		BasicDBObject query = new BasicDBObject();
		query.put("id", id_user);
		DBCursor cursor = coll.find(query);
		JSONArray ret = new JSONArray();
		while(cursor.hasNext()){
			DBObject b = cursor.next();
			JSONObject j = new JSONObject();
			j.put("id_mess", b.get("_id"));
			j.put("content", b.get("text"));
			
			// get comments
			
			ret.put(j);
		}
		return new JSONObject().put("messages", ret);
	}
	
	public static void removeMessage(String id_message,DBCollection coll){
		BasicDBObject query = new BasicDBObject();
		query.put("_id", new ObjectId(id_message));
		coll.remove(query);
	}
	
	public static boolean check_author(String id_user,String id_message, DBCollection coll){
		BasicDBObject query = new BasicDBObject();
		query.put("id", id_user);
		query.put("_id", new ObjectId(id_message));
		DBCursor cursor = coll.find(query);
		if (cursor.hasNext()){
			return true;
		}
		return false;
	}
	
	public static boolean exists(String id_message, DBCollection coll){
		BasicDBObject query = new BasicDBObject();
		query.put("_id", new ObjectId(id_message));
		
		DBCursor cursor = coll.find(query);
		if (cursor.hasNext()){
			return true;
		}
		return false;
	}

	
	public static void addComment(String id_user, String id_message, String text, DBCollection coll){
		GregorianCalendar calendar = new java.util.GregorianCalendar();
		Date d = calendar.getTime();
		
		DBObject searchQuery = new BasicDBObject("_id", new ObjectId(id_message));
		
		DBObject comment = new BasicDBObject();
		
		comment.put("id_user", id_user);
		comment.put("comment", text);
		comment.put("date", d);
		
		DBObject push = new BasicDBObject("$push", new BasicDBObject().append("comment", comment));
	
		coll.update(searchQuery, push);
	} 
}
